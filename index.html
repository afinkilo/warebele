<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Data Gudang Sederhana</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body { margin: 20px; }
        .container { max-width: 1200px; }
        .editable:hover { background-color: #f5f5f5; cursor: pointer; }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #ddd;
            background: white;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            width: calc(100% - 20px);
        }
        .autocomplete-suggestion {
            padding: 5px 10px;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover { background-color: #f0f0f0; }
        tr:hover { background-color: #e9ecef; cursor: pointer; }
        tr.selected { background-color: #d1e7dd; }
        .serial-number-list {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">Aplikasi Data Gudang</h2>

        <!-- Form Pencarian dan Import/Export -->
        <div class="mb-3">
            <div class="input-group">
                <input type="text" class="form-control" id="search" placeholder="Cari kode, nama barang, atau serial number">
                <button class="btn btn-primary" onclick="cariBarang()">Cari</button>
                <input type="file" class="form-control" id="importFile" accept=".xlsx, .xls, .json" onchange="importFile()">
                <button class="btn btn-info" onclick="fetchInventaris()">Refresh Data</button>
                <button class="btn btn-secondary" onclick="exportExcel()">Export Excel</button>
                <button class="btn btn-secondary" onclick="exportJson()">Export JSON</button>
                <button class="btn btn-danger" onclick="hapusSemuaData()">Hapus Semua Data</button>
            </div>
        </div>

        <!-- Form Input -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2 position-relative">
                        <input type="text" class="form-control" id="kode" placeholder="Kode Barang" oninput="showAutocomplete(this)">
                        <div id="autocompleteList" class="autocomplete-suggestions" style="display: none;"></div>
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="nama" placeholder="Nama Barang">
                    </div>
                    <div class="col-md-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hasSerialNumber" onchange="toggleSerialNumberInput()">
                            <label class="form-check-label" for="hasSerialNumber">
                                Memiliki Serial Number
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="masuk" placeholder="Jumlah Masuk">
                    </div>
                    <div class="col-md-2">
                        <input type="date" class="form-control" id="tanggalMasuk" placeholder="Tanggal Masuk">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="keterangan" placeholder="Keterangan">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success w-100" onclick="tambahBarang()">Tambah/Update</button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-warning w-100" onclick="undo()">Undo</button>
                    </div>
                </div>
                
                <!-- Form Serial Number (awalnya tersembunyi) -->
                <div id="serialNumberForm" class="row g-3 mt-3" style="display: none;">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                Input Serial Number
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="serialNumber" 
                                                placeholder="Masukkan Serial Number (pisahkan dengan koma)">
                                            <button class="btn btn-outline-secondary" type="button" onclick="addSerialNumber()">Tambah</button>
                                        </div>
                                        <small class="text-muted">Contoh: SN001, SN002, SN003</small>
                                    </div>
                                </div>
                                <div class="serial-number-list mt-3">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Serial Number</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="serialNumberList">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Pilih Serial Number untuk Barang Keluar -->
                <div id="selectSerialNumberForm" class="row g-3 mt-3" style="display: none;">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                Pilih Serial Number yang Keluar
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <p>Pilih serial number yang akan keluar:</p>
                                        <div class="serial-number-list mt-3">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Pilih</th>
                                                        <th>Serial Number</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="selectSerialNumberList">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabel Data dengan Pagination -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Kode Barang</th>
                        <th>Nama Barang</th>
                        <th>Masuk</th>
                        <th>Keluar</th>
                        <th>Stok</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabelBody">
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <label for="rowsPerPage">Baris per halaman:</label>
                <select id="rowsPerPage" class="form-select d-inline w-auto" onchange="updateTabel()">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                </select>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="previousPage()" id="prevBtn">Previous</button>
                <span id="pageInfo"></span>
                <button class="btn btn-secondary" onclick="nextPage()" id="nextBtn">Next</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Histori -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">Histori Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Tipe</th>
                                <th>Jumlah</th>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th>Serial Number</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Transaksi -->
    <div class="modal fade" id="transaksiModal" tabindex="-1" aria-labelledby="transaksiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transaksiModalLabel">Transaksi Barang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="transaksiForm">
                        <input type="hidden" id="transaksiKode">
                        <input type="hidden" id="transaksiTipe">
                        <div class="mb-3">
                            <label class="form-label">Kode Barang</label>
                            <input type="text" class="form-control" id="transaksiKodeBarang" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Barang</label>
                            <input type="text" class="form-control" id="transaksiNamaBarang" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jumlah</label>
                            <input type="number" class="form-control" id="transaksiJumlah" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="transaksiTanggal" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Keterangan</label>
                            <input type="text" class="form-control" id="transaksiKeterangan">
                        </div>
                        <div class="mb-3" id="serialNumberContainer" style="display: none;">
                            <label class="form-label">Serial Number</label>
                            <div id="serialNumberInputContainer">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="transaksiSerialNumber" placeholder="Masukkan Serial Number (pisahkan dengan koma)">
                                    <button class="btn btn-outline-secondary" type="button" onclick="addTransaksiSerialNumber()">Tambah</button>
                                </div>
                                <small class="text-muted">Contoh: SN001, SN002, SN003</small>
                            </div>
                            <div id="serialNumberSelectContainer" style="display: none;">
                                <p>Pilih serial number yang akan keluar:</p>
                            </div>
                            <div class="mt-2">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Serial Number</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaksiSerialNumberList">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="prosesTransaksi()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Library Bootstrap dan SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        const API_URL = 'https://afinkilo.github.io/warebele.github.io/api.php';
        let inventaris = [];
        let currentPage = 1;
        let rowsPerPage = 10;
        let filteredData = [];
        let selectedRowIndex = -1;
        let serialNumbers = [];
        let selectedSerialNumbers = [];
        let undoStack = []; // Stack untuk menyimpan history perubahan
        let lastAction = null; // Menyimpan aksi terakhir
        let transaksiSerialNumbers = [];

        // Toggle form serial number
        function toggleSerialNumberInput() {
            const hasSerialNumber = document.getElementById('hasSerialNumber').checked;
            const serialNumberForm = document.getElementById('serialNumberForm');
            
            if (serialNumberForm) {
                serialNumberForm.style.display = hasSerialNumber ? 'block' : 'none';
            }
                
            if (!hasSerialNumber) {
                serialNumbers = [];
                updateSerialNumberList();
            }
        }

        // Tambah serial number ke list
        function addSerialNumber() {
            const serialInput = document.getElementById('serialNumber');
            const serialNumbersInput = serialInput.value.trim();
            
            if (serialNumbersInput) {
                // Split input berdasarkan koma dan bersihkan whitespace
                const newSerialNumbers = serialNumbersInput.split(',')
                    .map(sn => sn.trim())
                    .filter(sn => sn !== ''); // Hapus string kosong

                // Validasi setiap serial number
                for (const serialNumber of newSerialNumbers) {
                    // Cek duplikasi di list serial number saat ini
                    if (serialNumbers.includes(serialNumber)) {
                        alert(`Serial number "${serialNumber}" sudah ada dalam list!`);
                        continue;
                    }

                    // Cek duplikasi di semua barang
                    const isDuplicate = inventaris.some(item => 
                        item.serialNumbers && item.serialNumbers.includes(serialNumber)
                    );

                    if (isDuplicate) {
                        alert(`Serial number "${serialNumber}" sudah digunakan di barang lain!`);
                        continue;
                    }

                    // Tambahkan ke list jika valid
                    serialNumbers.push(serialNumber);
                }

                // Update tampilan dan reset input
                updateSerialNumberList();
                serialInput.value = '';
            }
        }

        // Tambahkan event listener untuk tombol Enter pada input serial number
        document.getElementById('serialNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSerialNumber();
            }
        });

        // Update tampilan list serial number
        function updateSerialNumberList() {
            const tbody = document.getElementById('serialNumberList');
            tbody.innerHTML = '';
            
            serialNumbers.forEach((serial, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${serial}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeSerialNumber(${index})">Hapus</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Hapus serial number dari list
        function removeSerialNumber(index) {
            const removedSerial = serialNumbers[index];
            serialNumbers.splice(index, 1);
            updateSerialNumberList();

            // Hapus juga dari selectedSerialNumbers jika ada
            const selectedIndex = selectedSerialNumbers.indexOf(removedSerial);
            if (selectedIndex !== -1) {
                selectedSerialNumbers.splice(selectedIndex, 1);
                // Update jumlah keluar
                document.getElementById('keluar').value = selectedSerialNumbers.length;
                // Update tampilan list pemilihan
                updateSelectSerialNumberList();
            }
        }

        // Update tampilan list serial number yang bisa dipilih
        function updateSelectSerialNumberList() {
            const tbody = document.getElementById('selectSerialNumberList');
            tbody.innerHTML = '';
            
            const kode = document.getElementById('kode').value;
            const barang = inventaris.find(item => item.kode === kode);
            
            if (barang && barang.serialNumbers) {
                // Hitung jumlah serial number yang sudah keluar
                const usedSerialNumbers = new Set();
                barang.history.forEach(history => {
                    if (history.tipe === 'keluar' && history.serialNumbers) {
                        history.serialNumbers.forEach(sn => usedSerialNumbers.add(sn));
                    }
                });
                
                // Filter serial number yang masih tersedia
                const availableSerialNumbers = barang.serialNumbers.filter(sn => !usedSerialNumbers.has(sn));
                
                if (availableSerialNumbers.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="3" class="text-center">Tidak ada serial number yang tersedia</td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }
                
                // Tampilkan serial number yang masih tersedia
                availableSerialNumbers.forEach(sn => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <input type="checkbox" class="form-check-input" 
                                value="${sn}" 
                                onchange="toggleSerialNumberSelection('${sn}')"
                                ${selectedSerialNumbers.includes(sn) ? 'checked' : ''}>
                        </td>
                        <td>${sn}</td>
                        <td>Tersedia</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="3" class="text-center">Tidak ada serial number untuk barang ini</td>
                `;
                tbody.appendChild(tr);
            }
        }

        // Toggle pemilihan serial number
        function toggleSerialNumberSelection(serialNumber) {
            const index = selectedSerialNumbers.indexOf(serialNumber);
            if (index === -1) {
                selectedSerialNumbers.push(serialNumber);
            } else {
                selectedSerialNumbers.splice(index, 1);
            }
            
            // Update jumlah keluar sesuai jumlah serial number yang dipilih
            document.getElementById('keluar').value = selectedSerialNumbers.length;
            
            // Update tampilan list untuk memastikan checkbox tetap terpilih
            updateSelectSerialNumberList();
        }

        // Fungsi untuk mengambil data dari API
        async function fetchInventaris() {
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data received:', data); // Debug log
                
                if (!Array.isArray(data)) {
                    throw new Error('Data yang diterima bukan array');
                }
                
                inventaris = data.filter(item => 
                    item && 
                    typeof item.kode === 'string' && 
                    typeof item.nama === 'string' && 
                    typeof item.masuk === 'number' && 
                    typeof item.keluar === 'number' && 
                    Array.isArray(item.history)
                );
                
                console.log('Filtered data:', inventaris); // Debug log
                
                filteredData = [...inventaris].reverse();
                updateTabel();
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Gagal mengambil data dari server. Detail: ' + error.message);
                inventaris = [];
                filteredData = [];
                updateTabel();
            }
        }

        // Fungsi untuk menambah data baru ke API
        async function addInventaris(barang) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(barang)
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Gagal menambah data ke server');
                await fetchInventaris();
                return true;
            } catch (error) {
                console.error('Error adding inventaris:', error);
                throw error;
            }
        }

        // Fungsi untuk mengedit data di API
        async function updateInventaris(barang) {
            try {
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(barang)
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Gagal memperbarui data di server');
                await fetchInventaris();
                return true;
            } catch (error) {
                console.error('Error updating inventaris:', error);
                throw error;
            }
        }

        // Fungsi untuk menghapus data dari API
        async function deleteInventaris(kode) {
            try {
                const response = await fetch(API_URL, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kode })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Gagal menghapus data dari server');
                await fetchInventaris();
                return true;
            } catch (error) {
                console.error('Error deleting inventaris:', error);
                throw error;
            }
        }

        // Fungsi untuk menghitung ulang total masuk dan keluar dari history
        function recalculateTotals(barang) {
            if (!barang || !barang.history) {
                return barang;
            }

            let totalMasuk = 0;
            let totalKeluar = 0;
            let totalReturn = 0;
            
            // Hitung total masuk dan keluar terlebih dahulu
            barang.history.forEach(history => {
                const jumlah = parseInt(history.jumlah) || 0;
                if (history.tipe === 'restock') {
                    totalMasuk += jumlah;
                } else if (history.tipe === 'keluar') {
                    totalKeluar += jumlah;
                }
            });

            // Hitung total return dan kurangi dari keluar
            barang.history.forEach(history => {
                const jumlah = parseInt(history.jumlah) || 0;
                if (history.tipe === 'return') {
                    totalReturn += jumlah;
                    totalKeluar = Math.max(0, totalKeluar - jumlah);
                }
            });
            
            barang.masuk = totalMasuk;
            barang.keluar = totalKeluar;
            return barang;
        }

        // Fungsi untuk memperbarui tampilan tabel
        function updateTabel() {
            const tbody = document.getElementById('tabelBody');
            tbody.innerHTML = '';
            
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);
            
            if (pageData.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="6" class="text-center">Tidak ada data</td>
                `;
                tbody.appendChild(tr);
                return;
            }
            
            pageData.forEach((item, index) => {
                const tr = document.createElement('tr');
                const stok = (item.masuk || 0) - (item.keluar || 0);
                tr.innerHTML = `
                    <td>${item.kode}</td>
                    <td>${item.nama}</td>
                    <td>${item.masuk || 0}</td>
                    <td>${item.keluar || 0}</td>
                    <td>${stok}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showHistory('${item.kode}')">History</button>
                        <button class="btn btn-sm btn-warning" onclick="editBarang(${index})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="hapusBarang('${item.kode}')">Hapus</button>
                        <button class="btn btn-sm btn-success" onclick="showTransaksiModal('${item.kode}', 'restock')">Restock</button>
                        <button class="btn btn-sm btn-primary" onclick="showTransaksiModal('${item.kode}', 'return')">Return</button>
                        <button class="btn btn-sm btn-secondary" onclick="showTransaksiModal('${item.kode}', 'keluar')">Keluar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            updatePagination();
        }

        // Fungsi untuk menampilkan history
        function showHistory(kode) {
            const barang = inventaris.find(item => item.kode === kode);
            if (!barang) return;

            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            if (!barang.history || barang.history.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="6" class="text-center">Tidak ada history transaksi</td>
                `;
                tbody.appendChild(tr);
            } else {
                // Urutkan history berdasarkan tanggal (terbaru ke terlama)
                const sortedHistory = [...barang.history].sort((a, b) => {
                    return new Date(b.tanggal) - new Date(a.tanggal);
                });

                sortedHistory.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.tipe}</td>
                        <td>${item.jumlah}</td>
                        <td>${item.tanggal}</td>
                        <td>${item.keterangan || '-'}</td>
                        <td>${item.serialNumbers ? item.serialNumbers.join(', ') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="hapusHistory('${kode}', ${barang.history.indexOf(item)})">Hapus</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
        }

        // Fungsi untuk hapus history
        async function hapusHistory(kode, index) {
            if (!confirm('Apakah Anda yakin ingin menghapus history ini?')) return;

            const barang = inventaris.find(item => item.kode === kode);
            if (!barang) return;

            // Simpan state sebelum perubahan
            saveState('hapus history');

            // Simpan history yang akan dihapus untuk referensi
            const historyToDelete = barang.history[index];

            // Hapus history
            barang.history.splice(index, 1);
            
            // Jika history yang dihapus adalah history keluar, kembalikan serial number ke daftar
            if (historyToDelete.tipe === 'keluar' && historyToDelete.serialNumbers) {
                if (!barang.serialNumbers) {
                    barang.serialNumbers = [];
                }
                historyToDelete.serialNumbers.forEach(sn => {
                    if (!barang.serialNumbers.includes(sn)) {
                        barang.serialNumbers.push(sn);
                    }
                });
            }
            
            try {
                // Hitung ulang total dan update di server
                const updatedBarang = recalculateTotals(barang);
                await updateInventaris(updatedBarang);
                
                // Refresh data
                await fetchInventaris();
                
                // Update tampilan
                showHistory(kode);
                updateTabel();
            } catch (error) {
                alert('Gagal menghapus history: ' + error.message);
            }
        }

        // Fungsi untuk menambah/update barang
        async function tambahBarang() {
            try {
                // Ambil nilai dari form dengan null check
                const kodeInput = document.getElementById('kode');
                const namaInput = document.getElementById('nama');
                const masukInput = document.getElementById('masuk');
                const tanggalMasukInput = document.getElementById('tanggalMasuk');
                const keteranganInput = document.getElementById('keterangan');
                const hasSerialNumberInput = document.getElementById('hasSerialNumber');

                if (!kodeInput || !namaInput || !masukInput || !tanggalMasukInput || !keteranganInput || !hasSerialNumberInput) {
                    throw new Error('Form elements not found');
                }

                const kode = kodeInput.value;
                const nama = namaInput.value;
                const masuk = parseInt(masukInput.value) || 0;
                const tanggalMasuk = tanggalMasukInput.value;
                const keterangan = keteranganInput.value;
                const hasSerialNumber = hasSerialNumberInput.checked;

                if (!kode || !nama) {
                    alert('Kode dan nama barang harus diisi!');
                    return;
                }

                // Validasi serial number
                if (hasSerialNumber) {
                    if (masuk > 0 && (!serialNumbers || serialNumbers.length === 0)) {
                        alert('Harap tambahkan minimal satu serial number untuk barang masuk!');
                        return;
                    }

                    if (masuk > 0 && serialNumbers.length !== masuk) {
                        alert(`Jumlah serial number (${serialNumbers.length}) harus sama dengan jumlah barang masuk (${masuk})!`);
                        return;
                    }
                }

                // Simpan state sebelum perubahan
                saveState('tambah/edit');

                // Cari barang yang sudah ada
                const existingIndex = inventaris.findIndex(item => item.kode === kode);
                let barang;

                if (existingIndex >= 0) {
                    barang = { ...inventaris[existingIndex] };
                } else {
                    barang = {
                        kode,
                        nama,
                        masuk: 0,
                        keluar: 0,
                        serialNumbers: hasSerialNumber ? [] : undefined,
                        history: []
                    };
                }

                // Tambah history masuk jika ada
                if (masuk > 0 && tanggalMasuk) {
                    barang.history.push({
                        tipe: 'restock',
                        jumlah: masuk,
                        tanggal: tanggalMasuk,
                        keterangan: keterangan || 'Restock',
                        serialNumbers: hasSerialNumber ? [...serialNumbers] : []
                    });

                    if (hasSerialNumber) {
                        barang.serialNumbers = [...(barang.serialNumbers || []), ...serialNumbers];
                    }
                }

                // Hitung ulang total
                barang = recalculateTotals(barang);

                // Simpan ke server
                if (existingIndex >= 0) {
                    await updateInventaris(barang);
                } else {
                    await addInventaris(barang);
                }

                // Reset form
                kodeInput.value = '';
                namaInput.value = '';
                masukInput.value = '';
                tanggalMasukInput.value = '';
                keteranganInput.value = '';
                hasSerialNumberInput.checked = false;
                
                // Reset serial numbers
                serialNumbers = [];
                if (typeof toggleSerialNumberInput === 'function') {
                    toggleSerialNumberInput();
                }
                if (typeof updateSerialNumberList === 'function') {
                    updateSerialNumberList();
                }

                // Refresh data
                await fetchInventaris();
                alert('Data berhasil disimpan!');
            } catch (error) {
                console.error('Error in tambahBarang:', error);
                alert('Gagal menyimpan data: ' + error.message);
            }
        }

        // Fungsi untuk edit barang
        function editBarang(index) {
            const barang = filteredData[index];
            document.getElementById('kode').value = barang.kode;
            document.getElementById('nama').value = barang.nama;
            document.getElementById('hasSerialNumber').checked = barang.serialNumbers && barang.serialNumbers.length > 0;
            
            // Reset serial numbers
            serialNumbers = [];
            selectedSerialNumbers = [];
            
            toggleSerialNumberInput();
            
            if (barang.serialNumbers) {
                serialNumbers = [...barang.serialNumbers];
                updateSerialNumberList();
                updateSelectSerialNumberList();
            }
        }

        // Fungsi untuk hapus barang
        async function hapusBarang(kode) {
            if (!confirm('Apakah Anda yakin ingin menghapus barang ini?')) return;
            
            // Simpan state sebelum perubahan
            saveState('hapus');
            
            try {
                await deleteInventaris(kode);
                alert('Barang berhasil dihapus!');
                await fetchInventaris();
            } catch (error) {
                alert('Gagal menghapus barang: ' + error.message);
            }
        }

        // Fungsi untuk cari barang
        function cariBarang() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            filteredData = inventaris.filter(item => 
                item.kode.toLowerCase().includes(searchTerm) ||
                item.nama.toLowerCase().includes(searchTerm) ||
                (item.serialNumbers && item.serialNumbers.some(sn => sn.toLowerCase().includes(searchTerm)))
            ).reverse();
            
            currentPage = 1;
            updateTabel();
        }

        // Fungsi untuk update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        // Fungsi untuk next page
        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateTabel();
            }
        }

        // Fungsi untuk previous page
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTabel();
            }
        }

        // Fungsi untuk menyimpan state sebelum perubahan
        function saveState(action) {
            const state = {
                action: action,
                data: JSON.stringify(inventaris),
                timestamp: new Date().toISOString()
            };
            undoStack.push(state);
            // Batasi jumlah history yang disimpan (misal: 10 perubahan terakhir)
            if (undoStack.length > 10) {
                undoStack.shift();
            }
            lastAction = action;
        }

        // Fungsi untuk undo
        async function undo() {
            if (undoStack.length === 0) {
                alert('Tidak ada perubahan yang bisa dibatalkan');
                return;
            }

            const lastState = undoStack.pop();
            if (!lastState) return;

            if (!confirm(`Apakah Anda yakin ingin membatalkan aksi ${lastState.action} terakhir?`)) {
                return;
            }

            try {
                // Ambil state terakhir
                const previousData = JSON.parse(lastState.data);
                const currentData = inventaris;

                // Buat map untuk pencarian cepat
                const prevMap = new Map(previousData.map(item => [item.kode, item]));
                const currMap = new Map(currentData.map(item => [item.kode, item]));

                // 1. Tambahkan barang yang ada di previousData tapi tidak ada di currentData
                for (const [kode, item] of prevMap.entries()) {
                    if (!currMap.has(kode)) {
                        await addInventaris(item);
                    }
                }

                // 2. Hapus barang yang ada di currentData tapi tidak ada di previousData
                for (const [kode, item] of currMap.entries()) {
                    if (!prevMap.has(kode)) {
                        await deleteInventaris(kode);
                    }
                }

                // 3. Update barang yang ada di kedua data tapi isinya berbeda
                for (const [kode, prevItem] of prevMap.entries()) {
                    if (currMap.has(kode)) {
                        const currItem = currMap.get(kode);
                        if (JSON.stringify(prevItem) !== JSON.stringify(currItem)) {
                            await updateInventaris(prevItem);
                        }
                    }
                }

                // Refresh data
                await fetchInventaris();
                alert(`Aksi ${lastState.action} berhasil dibatalkan`);
            } catch (error) {
                alert('Gagal membatalkan perubahan: ' + error.message);
            }
        }

        // Fungsi export JSON
        function exportJson() {
            const dataStr = JSON.stringify(inventaris, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inventaris_gudang.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Fungsi export Excel
        function exportExcel() {
            // Siapkan data untuk SheetJS
            const data = inventaris.map(item => ({
                'Kode': item.kode,
                'Nama': item.nama,
                'Masuk': item.masuk,
                'Keluar': item.keluar,
                'Stok': (item.masuk || 0) - (item.keluar || 0),
                'Serial Numbers': item.serialNumbers ? item.serialNumbers.join(', ') : '',
                'History': item.history ? item.history.map(h => `${h.tipe} (${h.jumlah}) [${h.tanggal}] ${h.keterangan || ''}`).join(' | ') : ''
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inventaris');
            XLSX.writeFile(wb, 'inventaris_gudang.xlsx');
        }

        function updateReturnSerialNumbers(kode) {
            const barang = inventaris.find(item => item.kode === kode);
            if (!barang) return;

            // Hitung jumlah keluar dan return untuk setiap serial number
            const keluarCount = {};
            const returnCount = {};

            barang.history.forEach(history => {
                if (history.tipe === 'keluar' && Array.isArray(history.serialNumbers)) {
                    history.serialNumbers.forEach(sn => {
                        keluarCount[sn] = (keluarCount[sn] || 0) + 1;
                    });
                }
                if (history.tipe === 'return' && Array.isArray(history.serialNumbers)) {
                    history.serialNumbers.forEach(sn => {
                        returnCount[sn] = (returnCount[sn] || 0) + 1;
                    });
                }
            });

            // Serial number yang jumlah keluar > jumlah return
            const availableReturnSerialNumbers = Object.keys(keluarCount).filter(sn => 
                (keluarCount[sn] || 0) > (returnCount[sn] || 0)
            );

            const tbody = document.getElementById('transaksiSerialNumberList');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (availableReturnSerialNumbers.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="2" class="text-center">Tidak ada serial number yang bisa di-return</td>`;
                tbody.appendChild(tr);
                return;
            }

            availableReturnSerialNumbers.forEach(sn => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                value="${sn}" 
                                onchange="toggleTransaksiSerialNumber('${sn}')"
                                ${transaksiSerialNumbers.includes(sn) ? 'checked' : ''}>
                            <label class="form-check-label">${sn}</label>
                        </div>
                    </td>
                    <td>Keluar</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('transaksiJumlah').value = transaksiSerialNumbers.length;
        }

        // Tambahkan fungsi untuk menampilkan modal return
        function showTransaksiModal(kode, tipe) {
            const barang = inventaris.find(item => item.kode === kode);
            if (!barang) return;

            // Reset transaksiSerialNumbers setiap kali modal dibuka
            transaksiSerialNumbers = [];

            document.getElementById('transaksiKode').value = kode;
            document.getElementById('transaksiTipe').value = tipe;
            document.getElementById('transaksiKodeBarang').value = barang.kode;
            document.getElementById('transaksiNamaBarang').value = barang.nama;
            document.getElementById('transaksiJumlah').value = '';
            document.getElementById('transaksiTanggal').value = new Date().toISOString().split('T')[0];
            document.getElementById('transaksiKeterangan').value = '';
            
            const serialNumberContainer = document.getElementById('serialNumberContainer');
            const serialNumberInputContainer = document.getElementById('serialNumberInputContainer');
            const serialNumberSelectContainer = document.getElementById('serialNumberSelectContainer');

            // Jika barang tidak punya serial number, sembunyikan semua form serial number
            if (!barang.serialNumbers || barang.serialNumbers.length === 0) {
                if (serialNumberContainer) serialNumberContainer.style.display = 'none';
            } else {
                // Untuk return, selalu tampilkan form serial number (jika ada history keluar yang belum di-return)
                if (tipe === 'return') {
                    if (serialNumberContainer) serialNumberContainer.style.display = 'block';
                    if (serialNumberInputContainer) serialNumberInputContainer.style.display = 'none';
                    if (serialNumberSelectContainer) serialNumberSelectContainer.style.display = 'block';
                    updateReturnSerialNumbers(kode);
                } else if (tipe === 'keluar') {
                    if (serialNumberContainer) serialNumberContainer.style.display = 'block';
                    if (serialNumberInputContainer) serialNumberInputContainer.style.display = 'none';
                    if (serialNumberSelectContainer) serialNumberSelectContainer.style.display = 'block';
                    updateAvailableSerialNumbers(kode);
                } else if (tipe === 'restock') {
                    if (serialNumberContainer) serialNumberContainer.style.display = 'block';
                    if (serialNumberInputContainer) serialNumberInputContainer.style.display = 'block';
                    if (serialNumberSelectContainer) serialNumberSelectContainer.style.display = 'none';
                    const serialNumberInput = document.getElementById('transaksiSerialNumber');
                    if (serialNumberInput) {
                        serialNumberInput.value = '';
                    }
                }
            }

            // Update judul modal
            const judul = tipe === 'restock' ? 'Restock Barang' : 
                         tipe === 'return' ? 'Return Barang' : 'Barang Keluar';
            document.getElementById('transaksiModalLabel').textContent = judul;

            const modal = new bootstrap.Modal(document.getElementById('transaksiModal'));
            modal.show();
        }

        function updateAvailableSerialNumbers(kode) {
            const barang = inventaris.find(item => item.kode === kode);
            if (!barang) return;

            // Pastikan serialNumbers adalah array
            const serialNumbersArr = Array.isArray(barang.serialNumbers) ? barang.serialNumbers : [];

            // Kumpulkan semua serial number yang pernah keluar
            const usedSerialNumbers = new Set();
            barang.history.forEach(history => {
                if (history.tipe === 'keluar' && history.serialNumbers) {
                    history.serialNumbers.forEach(sn => usedSerialNumbers.add(sn));
                }
            });

            // Kumpulkan semua serial number yang sudah di-return
            const returnedSerialNumbers = new Set();
            barang.history.forEach(history => {
                if (history.tipe === 'return' && history.serialNumbers) {
                    history.serialNumbers.forEach(sn => returnedSerialNumbers.add(sn));
                }
            });

            // Filter serial number yang tersedia (termasuk yang sudah di-return)
            const availableSerialNumbers = serialNumbersArr.filter(sn =>
                !usedSerialNumbers.has(sn) || returnedSerialNumbers.has(sn)
            );

            const tbody = document.getElementById('transaksiSerialNumberList');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (availableSerialNumbers.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="2" class="text-center">Tidak ada serial number yang tersedia</td>
                `;
                tbody.appendChild(tr);
                return;
            }

            availableSerialNumbers.forEach(sn => {
                const tr = document.createElement('tr');
                const isReturned = returnedSerialNumbers.has(sn);
                tr.innerHTML = `
                    <td>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                value="${sn}" 
                                onchange="toggleTransaksiSerialNumber('${sn}')"
                                ${transaksiSerialNumbers.includes(sn) ? 'checked' : ''}>
                            <label class="form-check-label">${sn}</label>
                        </div>
                    </td>
                    <td>${isReturned ? 'Returned' : 'Tersedia'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleTransaksiSerialNumber(serialNumber) {
            const index = transaksiSerialNumbers.indexOf(serialNumber);
            if (index === -1) {
                transaksiSerialNumbers.push(serialNumber);
            } else {
                transaksiSerialNumbers.splice(index, 1);
            }
            
            // Update jumlah sesuai tipe transaksi
            const tipe = document.getElementById('transaksiTipe').value;
            document.getElementById('transaksiJumlah').value = transaksiSerialNumbers.length;
            
            // Update tampilan list untuk memastikan checkbox tetap terpilih
            const kode = document.getElementById('transaksiKode').value;
            if (tipe === 'keluar') {
                updateAvailableSerialNumbers(kode);
            } else if (tipe === 'return') {
                updateReturnSerialNumbers(kode);
            }
        }

        function addTransaksiSerialNumber() {
            const input = document.getElementById('transaksiSerialNumber');
            const serialNumbersInput = input.value.trim();
            
            if (serialNumbersInput) {
                const newSerialNumbers = serialNumbersInput.split(',')
                    .map(sn => sn.trim())
                    .filter(sn => sn !== '');

                for (const serialNumber of newSerialNumbers) {
                    if (transaksiSerialNumbers.includes(serialNumber)) {
                        alert(`Serial number "${serialNumber}" sudah ada dalam list!`);
                        continue;
                    }

                    const kode = document.getElementById('transaksiKode').value;
                    const barang = inventaris.find(item => item.kode === kode);
                    const tipe = document.getElementById('transaksiTipe').value;

                    if (tipe === 'restock') {
                        // Cek duplikasi di semua barang
                        const isDuplicate = inventaris.some(item => 
                            item.serialNumbers && item.serialNumbers.includes(serialNumber)
                        );

                        if (isDuplicate) {
                            alert(`Serial number "${serialNumber}" sudah digunakan di barang lain!`);
                            continue;
                        }
                    }

                    transaksiSerialNumbers.push(serialNumber);
                }

                updateTransaksiSerialNumberList();
                input.value = '';
            }
        }

        function updateTransaksiSerialNumberList() {
            const tbody = document.getElementById('transaksiSerialNumberList');
            tbody.innerHTML = '';
            
            transaksiSerialNumbers.forEach((serial, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${serial}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeTransaksiSerialNumber(${index})">Hapus</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function removeTransaksiSerialNumber(index) {
            transaksiSerialNumbers.splice(index, 1);
            updateTransaksiSerialNumberList();
        }

        async function prosesTransaksi() {
            try {
                const kode = document.getElementById('transaksiKode').value;
                const tipe = document.getElementById('transaksiTipe').value;
                const jumlah = parseInt(document.getElementById('transaksiJumlah').value) || 0;
                const tanggal = document.getElementById('transaksiTanggal').value;
                const keterangan = document.getElementById('transaksiKeterangan').value;

                if (!jumlah || !tanggal) {
                    alert('Jumlah dan tanggal harus diisi!');
                    return;
                }

                const barang = inventaris.find(item => item.kode === kode);
                if (!barang) return;

                // Pastikan history array ada
                if (!barang.history) {
                    barang.history = [];
                }

                // Validasi serial number hanya jika barang punya serial
                if (barang.serialNumbers && barang.serialNumbers.length > 0) {
                    if (tipe === 'restock' && transaksiSerialNumbers.length === 0) {
                        alert('Harap tambahkan minimal satu serial number untuk barang masuk!');
                        return;
                    }
                    if (tipe === 'keluar' && transaksiSerialNumbers.length === 0) {
                        alert('Harap pilih serial number yang akan keluar!');
                        return;
                    }
                    if (tipe === 'return' && transaksiSerialNumbers.length === 0) {
                        alert('Harap pilih serial number untuk barang return!');
                        return;
                    }

                    if (tipe === 'restock' && transaksiSerialNumbers.length !== jumlah) {
                        alert(`Jumlah serial number (${transaksiSerialNumbers.length}) harus sama dengan jumlah barang masuk (${jumlah})!`);
                        return;
                    }
                    if (tipe === 'keluar' && transaksiSerialNumbers.length !== jumlah) {
                        alert(`Jumlah serial number yang dipilih (${transaksiSerialNumbers.length}) harus sama dengan jumlah barang keluar (${jumlah})!`);
                        return;
                    }
                    if (tipe === 'return' && transaksiSerialNumbers.length !== jumlah) {
                        alert(`Jumlah serial number (${transaksiSerialNumbers.length}) harus sama dengan jumlah barang return (${jumlah})!`);
                        return;
                    }
                }
                // Untuk barang tanpa serial, tidak perlu validasi serial number

                // Simpan state sebelum perubahan
                saveState('transaksi');

                // Buat history entry
                const historyEntry = {
                    tipe: tipe,
                    jumlah: jumlah,
                    tanggal: tanggal,
                    keterangan: keterangan || (tipe === 'restock' ? 'Restock' : tipe === 'return' ? 'Return' : 'Distributed'),
                    serialNumbers: (barang.serialNumbers && barang.serialNumbers.length > 0) ? [...transaksiSerialNumbers] : []
                };

                // Tambahkan ke history
                barang.history.push(historyEntry);

                // Update serial numbers berdasarkan tipe transaksi
                if (barang.serialNumbers && barang.serialNumbers.length > 0) {
                    if (tipe === 'restock') {
                        barang.serialNumbers = [...(barang.serialNumbers || []), ...transaksiSerialNumbers];
                    } else if (tipe === 'keluar') {
                        barang.serialNumbers = barang.serialNumbers.filter(sn => !transaksiSerialNumbers.includes(sn));
                    } else if (tipe === 'return') {
                        barang.serialNumbers = [...(barang.serialNumbers || []), ...transaksiSerialNumbers];
                    }
                }

                // Hitung ulang total
                const updatedBarang = recalculateTotals(barang);

                // Simpan ke server
                await updateInventaris(updatedBarang);
                
                // Reset transaksiSerialNumbers
                transaksiSerialNumbers = [];
                
                // Tutup modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('transaksiModal'));
                modal.hide();
                
                // Refresh data
                await fetchInventaris();
                alert('Transaksi berhasil disimpan!');
            } catch (error) {
                console.error('Error in prosesTransaksi:', error);
                alert('Gagal menyimpan transaksi: ' + error.message);
            }
        }

        function showAutocomplete(input) {
            // Ambil value input
            const value = input.value.toLowerCase();
            const list = document.getElementById('autocompleteList');
            if (!list) return;

            // Sembunyikan jika input kosong
            if (!value) {
                list.style.display = 'none';
                list.innerHTML = '';
                return;
            }

            // Cari kode barang yang cocok
            const suggestions = inventaris
                .filter(item => item.kode.toLowerCase().includes(value))
                .map(item => item.kode);

            // Tampilkan suggestions
            if (suggestions.length > 0) {
                list.innerHTML = suggestions.map(kode =>
                    `<div class="autocomplete-suggestion" onclick="selectAutocomplete('${kode}')">${kode}</div>`
                ).join('');
                list.style.display = 'block';
            } else {
                list.style.display = 'none';
                list.innerHTML = '';
            }
        }

        function selectAutocomplete(kode) {
            document.getElementById('kode').value = kode;
            document.getElementById('autocompleteList').style.display = 'none';
            document.getElementById('autocompleteList').innerHTML = '';
        }

        // Inisialisasi event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Event listener untuk input keluar
            const keluarInput = document.getElementById('keluar');
            if (keluarInput) {
                keluarInput.addEventListener('input', function() {
                    const hasSerialNumber = document.getElementById('hasSerialNumber').checked;
                    const isKeluar = this.value > 0;
                    
                    document.getElementById('serialNumberForm').style.display = 
                        (hasSerialNumber && !isKeluar) ? 'block' : 'none';
                    document.getElementById('selectSerialNumberForm').style.display = 
                        (hasSerialNumber && isKeluar) ? 'block' : 'none';
                    
                    if (hasSerialNumber && isKeluar) {
                        updateSelectSerialNumberList();
                    }
                });
            }

            // Event listener untuk checkbox serial number
            const hasSerialNumberCheckbox = document.getElementById('hasSerialNumber');
            if (hasSerialNumberCheckbox) {
                hasSerialNumberCheckbox.addEventListener('change', function() {
                    const isKeluar = document.getElementById('keluar')?.value > 0;
                    
                    if (this.checked) {
                        if (isKeluar) {
                            document.getElementById('serialNumberForm').style.display = 'none';
                            document.getElementById('selectSerialNumberForm').style.display = 'block';
                            updateSelectSerialNumberList();
                        } else {
                            document.getElementById('serialNumberForm').style.display = 'block';
                            document.getElementById('selectSerialNumberForm').style.display = 'none';
                        }
                    } else {
                        document.getElementById('serialNumberForm').style.display = 'none';
                        document.getElementById('selectSerialNumberForm').style.display = 'none';
                        serialNumbers = [];
                        selectedSerialNumbers = [];
                        updateSerialNumberList();
                        updateSelectSerialNumberList();
                    }
                });
            }

            // Event listener untuk tombol search
            const searchInput = document.getElementById('search');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        cariBarang();
                    }
                });
            }

            // Event listener untuk input serial number
            const serialNumberInput = document.getElementById('serialNumber');
            if (serialNumberInput) {
                serialNumberInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addSerialNumber();
                    }
                });
            }

            // Load initial data
            fetchInventaris();
        });
    </script>
</body>
</html>